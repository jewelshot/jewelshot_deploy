/**
 * Credit Manager Tests
 * 
 * Tests for the atomic credit system
 */

import { describe, it, expect, vi, beforeEach } from 'vitest';
import { reserveCredit, confirmCredit, refundCredit, getUserCredits } from '@/lib/credit-manager';
import { createClient } from '@/lib/supabase/server';
import { createServiceClient } from '@/lib/supabase/service';

// Mocks are in setup.ts, get them here
const mockServiceClient = vi.mocked(createServiceClient);
const mockClient = vi.mocked(createClient);

// Create mock RPC functions
const mockClientRpc = vi.fn();
const mockServiceRpc = vi.fn();
const mockFrom = vi.fn();

describe('Credit Manager', () => {
  beforeEach(() => {
    vi.clearAllMocks();
    
    // Setup default mocks
    mockClient.mockResolvedValue({
      rpc: mockClientRpc,
      from: mockFrom,
    } as any);
    
    mockServiceClient.mockReturnValue({
      rpc: mockServiceRpc,
      from: mockFrom,
    } as any);
    
    // Default from mock for operation costs
    mockFrom.mockReturnValue({
      select: vi.fn().mockReturnValue({
        eq: vi.fn().mockReturnValue({
          single: vi.fn().mockResolvedValue({
            data: { cost: 10 },
            error: null,
          }),
        }),
      }),
    });
  });

  describe('reserveCredit', () => {
    it('should reserve credits successfully', async () => {
      mockClientRpc.mockResolvedValue({
        data: { transaction_id: 'tx-123' },
        error: null,
      });

      const result = await reserveCredit('user-123', 10, 'generate', 'test prompt');

      expect(result).toBe('tx-123');
      expect(mockClientRpc).toHaveBeenCalledWith('reserve_credit', {
        p_user_id: 'user-123',
        p_amount: 10,
        p_operation_type: 'generate',
        p_description: 'test prompt',
      });
    });

    it('should throw error when insufficient credits', async () => {
      mockClientRpc.mockResolvedValue({
        data: null,
        error: { message: 'Insufficient credits' },
      });

      await expect(
        reserveCredit('user-123', 10, 'generate', 'test')
      ).rejects.toThrow('Insufficient credits');
    });

    it('should throw error when user not found', async () => {
      mockClientRpc.mockResolvedValue({
        data: null,
        error: { message: 'User not found' },
      });

      await expect(
        reserveCredit('invalid-user', 10, 'generate', 'test')
      ).rejects.toThrow('User not found');
    });
  });

  describe('confirmCredit', () => {
    it('should confirm credit transaction successfully', async () => {
      mockServiceRpc.mockResolvedValue({
        data: null,
        error: null,
      });

      await expect(confirmCredit('tx-123')).resolves.not.toThrow();
      expect(mockServiceRpc).toHaveBeenCalledWith('confirm_credit', {
        p_transaction_id: 'tx-123',
      });
    });

    it('should throw error when transaction not found', async () => {
      mockServiceRpc.mockResolvedValue({
        data: null,
        error: { message: 'Transaction not found' },
      });

      await expect(confirmCredit('invalid-tx')).rejects.toThrow('Transaction not found');
    });
  });

  describe('refundCredit', () => {
    it('should refund credit transaction successfully', async () => {
      mockServiceRpc.mockResolvedValue({
        data: null,
        error: null,
      });

      await expect(
        refundCredit('tx-123', 'Operation failed')
      ).resolves.not.toThrow();

      expect(mockServiceRpc).toHaveBeenCalledWith('refund_credit', {
        p_transaction_id: 'tx-123',
        p_reason: 'Operation failed',
      });
    });
  });

  describe('getUserCredits', () => {
    it('should get user credits successfully', async () => {
      mockClientRpc.mockResolvedValue({
        data: {
          balance: 100,
          reserved: 10,
          available: 90,
        },
        error: null,
      });

      const credits = await getUserCredits('user-123');

      expect(credits).toEqual({
        balance: 100,
        reserved: 10,
        available: 90,
      });

      expect(mockClientRpc).toHaveBeenCalledWith('get_available_credits', {
        p_user_id: 'user-123',
      });
    });

    it('should throw error when user credits not found', async () => {
      mockClientRpc.mockResolvedValue({
        data: null,
        error: { message: 'User credits not found' },
      });

      await expect(getUserCredits('invalid-user')).rejects.toThrow();
    });
  });
});

